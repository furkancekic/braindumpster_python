{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Task Dashboard</h1>
                <p class="text-gray-600">Manage your AI-generated tasks and track your progress</p>
            </div>
            <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                üí¨ Back to Chat
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <span class="text-2xl">üìã</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Total Tasks</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalTasks">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <span class="text-2xl">‚è≥</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Pending</p>
                    <p class="text-2xl font-bold text-yellow-600" id="pendingTasks">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-lg">
                    <span class="text-2xl">‚úÖ</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Completed</p>
                    <p class="text-2xl font-bold text-green-600" id="completedTasks">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <span class="text-2xl">üí¨</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Conversations</p>
                    <p class="text-2xl font-bold text-purple-600" id="totalConversations">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks List -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="p-6 border-b">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Recent Tasks</h2>
                <div class="flex space-x-2">
                    <select id="statusFilter" class="border border-gray-300 rounded px-3 py-1 text-sm">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <button onclick="loadTasks()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                        Refresh
                    </button>
                    <button onclick="signOutUser()" class="bg-red-600 text-white px-4 py-1 rounded text-sm hover:bg-red-700">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
        
        <div id="tasksList" class="p-6">
            <div class="text-center text-gray-500 py-8">
                <span class="text-4xl">üìã</span>
                <p class="mt-2">Loading tasks...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCIjfY8IDQg4NRgsWF5yEHFTyFYRnJALi4",
        authDomain: "voicereminder-e1c91.firebaseapp.com",
        databaseURL: "https://voicereminder-e1c91-default-rtdb.firebaseio.com",
        projectId: "voicereminder-e1c91",
        storageBucket: "voicereminder-e1c91.firebasestorage.app",
        messagingSenderId: "28669271299",
        appId: "1:28669271299:web:7a951160eae3df5a141d36"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    let currentUserId = null;
    let currentUserToken = null;
    
    // Check authentication state
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUserId = user.uid;
            currentUserToken = await user.getIdToken();
            console.log('User authenticated:', currentUserId);
            // Load dashboard data once authenticated
            loadDashboardData();
        } else {
            console.log('User not authenticated');
            showAuthenticationPrompt();
        }
    });
    
    function showAuthenticationPrompt() {
        document.getElementById('tasksList').innerHTML = `
            <div class="text-center py-8">
                <span class="text-4xl">üîê</span>
                <h2 class="text-xl font-semibold text-gray-800 mt-4 mb-2">Authentication Required</h2>
                <p class="text-gray-600 mb-6">Please sign in to view your tasks</p>
                <div class="space-y-4">
                    <div>
                        <input type="email" id="emailInput" placeholder="Email" class="w-full max-w-sm mx-auto block border border-gray-300 rounded px-4 py-2 mb-2" />
                        <input type="password" id="passwordInput" placeholder="Password" class="w-full max-w-sm mx-auto block border border-gray-300 rounded px-4 py-2 mb-4" />
                    </div>
                    <div class="space-x-2">
                        <button onclick="signInUser()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            Sign In
                        </button>
                        <button onclick="signUpUser()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                            Sign Up
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Hide stats cards
        document.getElementById('totalTasks').textContent = '-';
        document.getElementById('pendingTasks').textContent = '-';
        document.getElementById('completedTasks').textContent = '-';
        document.getElementById('totalConversations').textContent = '-';
    }
    
    async function signInUser() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        
        if (!email || !password) {
            alert('Please enter both email and password');
            return;
        }
        
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error('Sign in error:', error);
            alert('Sign in failed: ' + error.message);
        }
    }
    
    async function signUpUser() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        
        if (!email || !password) {
            alert('Please enter both email and password');
            return;
        }
        
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Register user with backend
            const idToken = await user.getIdToken();
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify({
                    email: user.email,
                    display_name: user.displayName || user.email.split('@')[0]
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to register user with backend');
            }
            
            alert('Account created successfully!');
        } catch (error) {
            console.error('Sign up error:', error);
            alert('Sign up failed: ' + error.message);
        }
    }
    
    function signOutUser() {
        auth.signOut();
    }
    
    // Load data when page loads - removed since we now wait for auth state
    // Data will be loaded in auth state change handler
    
    async function loadDashboardData() {
        await Promise.all([
            loadStats(),
            loadTasks()
        ]);
    }
    
    async function loadStats() {
        if (!currentUserId || !currentUserToken) return;
        
        try {
            const response = await fetch(`/api/tasks/stats/${currentUserId}`, {
                headers: {
                    'Authorization': `Bearer ${currentUserToken}`
                }
            });
            const data = await response.json();
            
            if (data.stats) {
                document.getElementById('totalTasks').textContent = data.stats.total;
                document.getElementById('pendingTasks').textContent = data.stats.pending;
                document.getElementById('completedTasks').textContent = data.stats.completed;
                
                // Get conversations count from profile
                const profileResponse = await fetch(`/api/auth/profile/${currentUserId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentUserToken}`
                    }
                });
                const profileData = await profileResponse.json();
                document.getElementById('totalConversations').textContent = profileData.stats?.conversations || 0;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    async function loadTasks() {
        if (!currentUserId || !currentUserToken) return;
        
        try {
            const statusFilter = document.getElementById('statusFilter').value;
            const url = `/api/tasks/user/${currentUserId}${statusFilter ? `?status=${statusFilter}` : ''}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${currentUserToken}`
                }
            });
            const data = await response.json();
            
            const tasksList = document.getElementById('tasksList');
            
            if (data.tasks && data.tasks.length > 0) {
                // Sort tasks by due_date (earliest first), then by created_at for tasks without due_date
                const sortedTasks = data.tasks.sort((a, b) => {
                    // If both have due dates, compare them
                    if (a.due_date && b.due_date) {
                        return new Date(a.due_date) - new Date(b.due_date);
                    }
                    // If only a has due date, it comes first
                    if (a.due_date && !b.due_date) {
                        return -1;
                    }
                    // If only b has due date, it comes first
                    if (!a.due_date && b.due_date) {
                        return 1;
                    }
                    // If neither has due date, sort by created_at (newest first)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                tasksList.innerHTML = sortedTasks.map(task => `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800 mb-2">${task.title}</h3>
                                <p class="text-gray-600 text-sm mb-3">${task.description}</p>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="bg-${getPriorityColor(task.priority)}-100 text-${getPriorityColor(task.priority)}-800 px-2 py-1 rounded">
                                        ${task.priority} priority
                                    </span>
                                    <span class="bg-${getStatusColor(task.status)}-100 text-${getStatusColor(task.status)}-800 px-2 py-1 rounded">
                                        ${task.status}
                                    </span>
                                    ${task.due_date ? `<span>üìÖ ${formatDate(task.due_date)}</span>` : ''}
                                    <span>üïí ${formatDate(task.created_at)}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                ${task.status === 'pending' ? `
                                    <button onclick="updateTaskStatus('${task.id}', 'approved')" 
                                            class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                        Approve
                                    </button>
                                ` : ''}
                                ${task.status === 'approved' ? `
                                    <button onclick="updateTaskStatus('${task.id}', 'completed')" 
                                            class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                        Complete
                                    </button>
                                ` : ''}
                                ${hasActiveReminders(task) ? `
                                    <button onclick="stopTaskReminders('${task.id}')" 
                                            class="bg-orange-600 text-white px-3 py-1 rounded text-xs hover:bg-orange-700">
                                        üîï Stop Reminders
                                    </button>
                                ` : ''}
                                <button onclick="deleteTask('${task.id}')" 
                                        class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                tasksList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <span class="text-4xl">üìã</span>
                        <p class="mt-2">No tasks found</p>
                        <a href="/" class="text-blue-600 hover:text-blue-700 mt-2 inline-block">
                            Create your first task
                        </a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading tasks:', error);
            document.getElementById('tasksList').innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <span class="text-4xl">‚ùå</span>
                    <p class="mt-2">Error loading tasks</p>
                </div>
            `;
        }
    }
    
    async function updateTaskStatus(taskId, newStatus) {
        if (!currentUserToken) return;
        
        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUserToken}`
                },
                body: JSON.stringify({
                    status: newStatus
                })
            });
            
            if (response.ok) {
                await loadDashboardData(); // Refresh data
            } else {
                alert('Failed to update task status');
            }
        } catch (error) {
            console.error('Error updating task:', error);
            alert('Error updating task status');
        }
    }
    
    async function deleteTask(taskId) {
        if (!currentUserToken) return;
        
        if (confirm('Are you sure you want to delete this task?')) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentUserToken}`
                    }
                });
                
                if (response.ok) {
                    await loadDashboardData(); // Refresh data
                } else {
                    alert('Failed to delete task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task');
            }
        }
    }
    
    function getPriorityColor(priority) {
        const colors = {
            'urgent': 'red',
            'high': 'orange',
            'medium': 'blue',
            'low': 'gray'
        };
        return colors[priority] || 'gray';
    }
    
    function getStatusColor(status) {
        const colors = {
            'pending': 'yellow',
            'approved': 'blue',
            'completed': 'green',
            'cancelled': 'red'
        };
        return colors[status] || 'gray';
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Add event listener for status filter
    document.getElementById('statusFilter').addEventListener('change', loadTasks);
    
    // Function to check if task has active reminders
    function hasActiveReminders(task) {
        if (!task.reminders || task.reminders.length === 0) return false;
        return task.reminders.some(reminder => !reminder.sent);
    }
    
    // Function to stop task reminders
    async function stopTaskReminders(taskId) {
        if (!currentUserToken) return;
        
        if (!confirm('Are you sure you want to stop all reminders for this task?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/tasks/${taskId}/stop-reminders`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUserToken}`
                }
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert('Reminders stopped successfully!');
                loadTasks(); // Reload tasks to update UI
            } else {
                alert('Error stopping reminders: ' + result.error);
            }
        } catch (error) {
            alert('Error stopping reminders: ' + error.message);
        }
    }
</script>
{% endblock %}